---
title: Installing and Configuring ClamAV for PCF
owner: Pivotal Compliance and Innovation (PCI) Team
---
<strong><%= modified_date %></strong>

This topic describes how to install and configure <%= vars.product_full %>.

##<a id="prereqs"></a>Prerequisites

To install ClamAV Add-on, you must have the following:

* **A PCF operator with admin rights**.
For more information, see [Operators](https://docs.pivotal.io/pivotalcf/customizing/user-types.html#operator).

* **PCF Operations Manager (Ops Manager)**.
For compatible versions, see the [Product Snapshot](./index.html#snapshot).

* **At least 1&nbsp;GB of memory free on each VM**.
ClamAV Add-on uses 610&nbsp;MB of memory.

## <a id='install-mirror'></a> (Optional) Install ClamAV Mirror for PCF

If you do not have an external mirror for ClamAV jobs to fetch databases updates from, you can deploy one using the ClamAV Mirror for PCF.
This deployed mirror can support air gapped environments.

1. Download the product file from [Pivotal Network](https://network.pivotal.io/products/p-clamav-addon).

1. Navigate to the Ops Manager Installation Dashboard and select **Import a Product** to upload the product file.

1. Under the **Import a Product** button, click **+** next to the version number of ClamAV Mirror for PCF.
This adds the tile to your staging area.

1. Click the newly added **ClamAV Mirror for PCF** tile.

### <a id='azs'></a> Assign AZs and Networks
To assign AZs and networks, click the **Assign AZs and Networks** settings tab.

1. Configure the fields as follows:

    <table class="nice">
      <th>Field</th>
      <th>Description</th>
      <tr>
        <td><strong>Place singleton jobs in</strong></td>
        <td>Select the AZ that you want the <code>clamav_mirror</code> VM to run in.</td>
      </tr>
      <tr>
        <td><strong>Balance other jobs in</strong></td>
        <td>Select the same AZ as above.</td>
      </tr>
      <tr>
        <td><strong>Network</strong></td>
        <td>Select a subnet for the <code>clamav_mirror</code> VM. <br>This is typically the same subnet that
          includes the Pivotal Application Services (PAS) component VMs.</td>
      </tr>
    </table>

1. Click **Save**.

### <a id='configure-mirror'></a> Configure ClamAV Mirror for PCF
To configure ClamAV Mirror for PCF, do the following:

1. Click **ClamAV Mirror Configuration**.

1. Configure the output destination of the logs from the ClamAV mirror job
to one of the following supported options:

* `stdout`: sends messages to /var/vcap/sys/log/clamav-mirror/clamav-mirror.stdout.log.
* `stderr`: sends messages to /var/vcap/sys/log/clamav-mirror/clamav-mirror.stderr.log.
* `syslog`: sends messages to /var/log/messages.

1. The ClamAV Mirror for PCF will serve virus definitions to your environment for the ClamAV Add-on for PCF to use, but the ClamAV Mirror needs to get databases itself.
You can configure the ClamAV Mirror to get virus definitions from one of the following supported options:

<%# TODO Dylan: less verbose things with tile field updates %>
* `Manual updates(I will ssh stuff myself)`: Suited for air gapped environments, or if you want to control the database versions available to your environment
* `Use the ClamAV official mirror`: The Mirror will fetch databases from `database.clamav.net`
* `I have my own mirror`: Allows you to enter a list of hostnames or IPs of mirrors

### <a id='proxy'></a> (Optional) Configure HTTP Proxy for ClamAV Mirror Jobs

If you selected `Use the ClamAV official mirror` or `I have my own mirror` in the previous section, you can configure a proxy for the ClamAV Mirror to retrieve the databases from.
To do this, click **HTTP Proxy Configuration for ClamAV Mirror Jobs** and set
**HTTP proxy for ClamAV jobs to get database updates** to `Enabled`.
Then enter the `host`, `port`, `username` and `password` in the fields that appear.

###<a id="syslog"></a> Configure System Logging
Follow the steps below to enable system logging for ClamAV Mirror.
Logs use RFC5424 format.

1. Click **Syslog**.
1. Click **Yes**.

    <<<SCREENSHOT>>>

1. Configure the fields as follows:
  <table>
    <tr><th>Field</th><th>Instructions</th></tr>
    <tr>
        <td><strong>Address</strong></td>
        <td>Enter the address or host of the syslog server for sending logs, for example,
            <code>logmanager.example.com</code>.</td></tr>
    <tr><td><strong>Port</strong></td>
        <td>Enter the port of the syslog server for sending logs, for example, <code>29279</code>.</td></tr>
    <tr><td><strong>Transport Protocol</strong></td>
        <td>Select the protocol over which you want system logs. Pivotal recommends using TCP.</td></tr>
    <tr><td><strong>Enable TLS</strong></td>
    <td>If you select TCP, you can also select to send logs encrypted over TLS.</td></tr>
    <tr><td><strong>Permitted Peer</strong></td>
        <td>Enter either the accepted fingerprint, in SHA1, or the name of the remote peer, for example, <code>*.example.com</strong></td></tr>
    <tr><td><strong>SSL Certificate</strong></td>
        <td>Enter the SSL Certificate(s) for the syslog server. This ensures the logs are transported securely.</td></tr>
  </table>
  <p class="note"><strong>IMPORTANT</strong>: If your syslog server is external to PCF, you might need to select
            <strong>Provide public IP addresses to all Service VMs</strong> on the <strong>Settings</strong> page.<p>

1. Click **Save**.

## <a id='resources-mirror'></a> Configure Resource Config
You can scale up the number of deployed mirrors by clicking **Resource Config**
and setting the number of `clamav-mirror` instances to the number of mirrors that
you want to deploy.
The ClamAV jobs do load balancing for you,
<%# TODO Dylan: confirm next line %>
but you need to **Apply Changes** for the ClamAV jobs to detect the number of mirrors.

### <a id="apply-changes-mirror"></a> Apply Changes from Your Configuration
Your ClamAV Mirror installation is not complete until you apply your configuration changes.
To do this, follow the procedure below:

1. Return to the Ops Manager Installation Dashboard.

1. Click **Review Pending Changes**.
1. Unselect all products except `BOSH Director` and `ClamAV Mirror for PCF` and click **Apply Changes**.
1. After **Apply Changes** is complete, if you selected `Manual updates(I will ssh stuff myself)`, upload a set of virus definitions
to your deployed `clamav-mirrors`.
To do this, see [Updating Virus Definitions on Deployed ClamAV Mirrors](./updating-databases.html).

## <a id='install-addon'></a> Install <%= vars.product_short %>

To install the <%= vars.product_short %> file on the Ops Manager Installation Dashboard, do the following:

1. Download the product file from [Pivotal Network](https://network.pivotal.io/products/p-clamav-addon).

1. Navigate to the Ops Manager Installation Dashboard and select **Import a Product** to upload the product file.

1. Under the **Import a Product** button, click **+** next to the version number of <%= vars.product_short %>.
This adds the tile to your staging area.

1. Click the newly added **<%= vars.product_short %>** tile.

## <a id='configure'></a> Configure <%= vars.product_short %>
To configure <%= vars.product_short %>, do the following:

1. Click **ClamAV Configuration**.

1. ClamAV needs to fetch virus databases from an upstream mirror. You can configure it to one of the following supported options:

* `Use the ClamAV official mirror`: Jobs will fetch databases from `database.clamav.net`
* `Use a deployed mirror from the ClamAV Mirror Tile`. For more information, see [Install ClamAV Mirror for PCF](#install-mirror).
* `Private Mirror`: Allows you to enter a list of hostnames or IPs of mirrors

1. (Optional) If you want to scan files immediately after they are modified,
then select **Enable on-access scanning**.

    <p class="note"><strong>Note</strong>: On-Access Scan is not supported on Windows.</p>

1. Fill out the following fields:

    <table class="nice">
      <th>Field</th>
      <th>Description</th>
      <tr>
        <td><strong>Memory limit (in bytes)</strong></td>
        <td>The maximum amount of user memory (including file cache) in bytes that ClamAV can use.
          The default value is <code>1610612736</code>.</td>
      </tr>
      <tr>
        <td><strong>(Optional) Enforce CPU limit</strong></td>
        <td>This limits the amount of CPU the ClamAV processes can use.
            To enforce this limit, select <strong>Enable</strong>,
            then enter a value in the <strong>CPU limit (percentage)</strong> field.</td>
      </tr>
      <tr>
        <td><strong>Action to take when a virus is found</strong></td>
        <td>Select one of the following options:<br>
            <ul>
              <li><code>notify</code>: (Default) Only send a notification to syslog</li>
              <li><code>remove</code>: Delete the infected file from the filesystem</li>
              <li><code>move</code>: Move the infected file to a specified directory</li>
              <li><code>copy</code>: Copy the infected file to a specified directory</li>
            </ul>

            For the <code>move</code> and <code>copy</code> options, a field
            for <strong>Destination for infected files</strong> appears after the
            option is selected.</td>
      </tr>
      <tr>
        <td><strong>Directories and files that will be ignored by ClamAV</strong></td>
        <td>A comma-separated list of directories for ClamAV to not scan.
          The default value is "<code>/proc/</code>,<code>/sys/</code>".
          This configures ClamAV scans to exclude the <code>/proc</code> and
          <code>/sys</code> directories.<br>
          Pivotal recommends that you include the <code>/proc</code> and
          <code>/sys</code> directories in the <code>exclude_paths</code> list.</td>
      </tr>
      <tr>
        <td><strong>List of signature names that will be ignored by ClamAV (Used for false positives)</strong></td>
        <td>A comma-separated list of signature names for ClamAV to whitelist.
          For example, "<code>Eicar-Test-Signature</code>,<code>Clamav.Test.File-7</code>"
          will configure ClamAV to ignore the <strong>Eicar Test File</strong>
          and <strong>ClamAV Test File-7</strong> signatures.</td>
      </tr>
    </table>

    <div class="note warning"><strong>Warning:</strong>
      If you select <code>move</code> or <code>copy</code> when selecting an
      <strong>Action to take when a virus is found</strong>, make sure that the
      <strong>Destination for infected files</strong> path is also added to the
      <strong>Directories and files that will be ignored by ClamAV</strong> list.<br><br>
      If you do not do this, then ClamAV:<br>
      <ul>
        <li>Detects the moved or copied file</li>
        <li>Logs redundant alerts</li>
        <li>Creates additional copies of the detected file</li>
      </ul>
    </div>


If a scan is reporting false positives, report the issue to
[ClamAV](https://www.clamav.net/reports/fp).
For more information about false positives, see
[ClamAV Reports False Positives](./troubleshooting.html#false-positive-clamav).
It takes about a week for ClamAV to verify and publish a new database.


## <a id='proxy'></a> Configure HTTP Proxy
If you require a proxy server for ClamAV jobs to connect to the internet to
update their virus definitions, you can configure one.
To do this, click **HTTP Proxy Configuration for ClamAV Jobs** and set
**HTTP proxy for ClamAV jobs to get database updates** to `Enabled`.
Then enter the `proxy host`, `port`, `username` and `password` in the fields that appear.


## <a id='scheduled'></a> Configure Scheduled Scan
ClamAV can be configured to run a virus scan `hourly` or `daily`.
The default value is `daily`.
The format of these values must be in 24-hour format `HH:MM`.

To change the scheduled scan value, do the following:

1. Click **Scheduled Scans**
1. Set **Interval for scheduled scans to run** to one of the following:
  * `hourly`
  * `daily`
  * `disabled`

For `daily` scheduled scans, you can restrict the interval.
To do this, set **Earliest time that a daily scheduled scan can start** and
**Latest time that a daily scheduled scan can start**.

## <a id="apply-changes"></a> Apply Changes from Your Configuration
Your installation is not complete until you apply your configuration changes.
To do this, follow the procedure below:

1. Return to the Ops Manager Installation Dashboard.
1. Click **Review Pending Changes**.
1. Ensure all products are selected and click **Apply Changes**.


##<a id="scan-containers"></a>Configure ClamAV to Exclude Duplicate Logs on Containers
You can use ClamAV to scan the following:

* Garden containers on the Diego Cell VMs in Pivotal Application Service (PAS)
* Containers on the Kubernetes worker node VMs in Enterprise Pivotal Container Service (Enterprise PKS)

However, duplicate logs about the same file will appear under the `diff`,
`rootfs`, or `merged` directories as a consequence of OverlayFS implementation.

To configure ClamAV to ignore duplicate logs for these directories, see the optional
[Exclude Duplicate Logs on Garden Containers](#garden) or
[Exclude Duplicate Logs on Containers in Enterprise PKS](#pks) sections below:


###<a id="garden"></a> (Optional) Exclude Duplicate Logs on Garden Containers
When ClamAV scan results detect potential malware on the Garden containers,
logs are reported for both the `diff` and `rootfs` directories.

This is because the `rootfs` directory is the projection of
the `diff` directory on top of a base image layer, therefore it is safe to
ignore the `rootfs` directory.
GrootFS mounts the underlying volumes using OverlayFS to a point in the images directory.
This mount point is the `rootfs` directory for the container and is read-write.

For more information about GrootFS OverlayFS implementation, see
[Volumes](https://docs.cloudfoundry.org/concepts/grootfs-disk.html#volumes)
in the Cloud Foundry documentation.

If you would like to configure ClamAV to ignore duplicate logs for these directories,
do the following:

1. In [Exclude Files and Directories](#exclude) above, add the following pattern to the `exclude_paths` property:

        clamav:
          exclude_paths:
            ...
            # When scanning Garden containers,
            # ignore duplicate log messages from .../UUID/rootfs/
            - ^/var/vcap/data/grootfs/store/(un)?privileged/images/[\w-]+/rootfs/.*$

    <p class="note"><strong>Note:</strong>
      Adding this ignore pattern means that files and directories in the
      <code>/var/vcap/data/grootfs/store/unprivileged/images/UUID/rootfs</code>
      directory are ignored by ClamAV. <code>UUID</code> is the ID of the container.</p>

For an example log message, see [Container Log Messages](./monitoring-logs.html#container).


###<a id="pks"></a> (Optional) Exclude Duplicate Logs on Containers in Enterprise PKS
When ClamAV scan results detect potential malware on containers of the Kubernetes
worker node VMs in Enterprise PKS, logs are reported for both the
`diff` and `merged` directories.

This is because the `merged` directory is the projection of
the `diff` directory on top of a base image layer, therefore it is safe to
ignore the `merged` directory.

For more information about Docker OverlayFS implementation, see
[Use the OverlayFS storage driver](https://docs.docker.com/storage/storagedriver/overlayfs-driver/)
in the Docker documentation.

If you would like to configure ClamAV to ignore duplicate logs for these directories,
do the following:

1. In [Exclude Files and Directories](#exclude) above, add the following pattern to the `exclude_paths` property:

        clamav:
          exclude_paths:
            ...
            # When scanning Kubernetes containers,
            # ignore duplicate log messages from .../UUID/merged/
            - ^/var/vcap/data/grootfs/store/(un)?privileged/images/[\w-]+/rootfs/.*$

    <p class="note"><strong>Note:</strong>
      Adding this ignore pattern means that files and directories in the
      <code>/var/vcap/data/grootfs/store/unprivileged/images/UUID/merged</code>
      directory are ignored by ClamAV. <code>UUID</code> is the ID of the container.</p>

For an example log message, see [Container Log Messages](./monitoring-logs.html#container).
